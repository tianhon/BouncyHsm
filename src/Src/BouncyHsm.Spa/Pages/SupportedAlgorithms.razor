@page "/SupportedAlgorithms"
@using BouncyHsm.Client
@using BouncyHsm.Spa.Shared.ForSupportedAlgorithms
@inject IBouncyHsmClient bouncyHsmClient

<PageTitle>Supported algorithms</PageTitle>

<h1>Supported algorithms</h1>

<p>List with actual supported mechanisms and eliptic curves.</p>

<h2>Mechanisms</h2>

@if (this.mechanisms == null)
{
    <BouncyHsm.Spa.Shared.Common.LoadingIndicator />
}
else
{
    @if (this.profileName != null)
    {
        <div class="alert @* alert-success *@ alert alert-warning mt-1 mb-3" role="alert">
            <h4 class="alert-heading">Profile: @this.profileName</h4>
            <p>
                The list of supported mechanisms and named eliptic curves was modified using the configuration in the <strong>@this.profileName</strong> profile.<br />
                If you want to use <a href="https://github.com/harrison314/BouncyHsm/blob/main/Doc/SupportedAlgorithms.md" target="_blank">all mechanisms and named eliptic curves</a> provided by BouncyHsm, disable the profile in the configuration.
            </p>
        </div>
    }

    <p>
        <em>Bouncy&nbsp;Hsm</em> provides PKCS#11 interfaces for versions <a href="https://docs.oasis-open.org/pkcs11/pkcs11-curr/v2.40/os/pkcs11-curr-v2.40-os.pdf" target="_blank">2.40</a>,
        <a href="https://docs.oasis-open.org/pkcs11/pkcs11-spec/v3.1/os/pkcs11-spec-v3.1-os.pdf" target="_blank">3.1</a>, 
        and&nbsp;<a href="https://docs.oasis-open.org/pkcs11/pkcs11-spec/v3.2/pkcs11-spec-v3.2.pdf" target="_blank">3.2</a>, these versions are backward compatible.
        The specification in which the mechanism was added is indicated for each mechanism.<br />
        The mechanism can also be used in older versions of the native API.
    </p>

    <table class="table table-responsive-md table-striped table-bordered">
        <thead>
            <tr>
                <th>Mechanism</th>
                <th>Min. key size</th>
                <th>Max. key size</th>
                <th>Digest</th>
                <th>Sign, Verify</th>
                <th>SignRecover, VerifyRecover</th>
                <th>Derive</th>
                <th>Encrypt, Decrypt</th>
                <th>Generate key pair</th>
                <th>Generate key</th>
                <th>Wrap, Unwrap</th>
                <th>Encapsulate, Decapsulate</th>
            </tr>
        </thead>
        <tbody>
            @foreach (MechanismInfoDto mi in this.mechanisms)
            {
                <tr>
                    <td class="code">@mi.MechanismType <Pkcs11Version Version="@mi.SpecificationVersion" /></td>
                    <td class="text-end">@mi.MinKeySize</td>
                    <td class="text-end">@mi.MaxKeySize</td>
                    <td class="text-center" title="Digest">@ShowFlag(mi.Flags.Digest)</td>
                    <td class="text-center" title="Sign, Verify">@ShowFlag(mi.Flags.Sign, mi.Flags.Verify)</td>
                    <td class="text-center" title="SignRecover, VerifyRecover">@ShowFlag(mi.Flags.SignRecover, mi.Flags.VerifyRecover)</td>
                    <td class="text-center" title="Derive">@ShowFlag(mi.Flags.Derive)</td>
                    <td class="text-center" title="Encrypt, Decrypt">@ShowFlag(mi.Flags.Encrypt, mi.Flags.Decrypt)</td>
                    <td class="text-center" title="Generate key pair">@ShowFlag(mi.Flags.GenerateKeyPair)</td>
                    <td class="text-center" title="Generate key">@ShowFlag(mi.Flags.Generate)</td>
                    <td class="text-center" title="Wrap, Unwrap">@ShowFlag(mi.Flags.Wrap, mi.Flags.Unwrap)</td>
                    <td class="text-center" title="Encapsulate, Decapsulate">@ShowFlag(mi.Flags.Encapsulate, mi.Flags.Decapsulate)</td>
                </tr>
            }
        </tbody>
    </table>

    <h2>Elliptic curves</h2>

    @if (this.curves == null)
    {
        <BouncyHsm.Spa.Shared.Common.LoadingIndicator />
    }
    else
    {
        <table class="table table-responsive-md table-striped table-bordered">
            <thead>
                <tr>
                    <th>Kind</th>
                    <th>Curve</th>
                    <th>OID</th>
                </tr>
            </thead>
            <tbody>
                @foreach (CurveInfoDto cr in this.curves)
                {
                    <tr>
                        <td>@cr.Kind</td>
                        <td>@cr.Name</td>
                        <td class="fst-italic">@cr.Oid</td>
                    </tr>
                }
            </tbody>
        </table>


        <h2>Edwards curves</h2>
        @if (this.edwardsCurves == null)
        {
            <BouncyHsm.Spa.Shared.Common.LoadingIndicator />
        }
        else
        {
            <table class="table table-responsive-md table-striped table-bordered">
                <thead>
                    <tr>
                        <th>Kind</th>
                        <th>Curve</th>
                        <th>Curve Name</th>
                        <th>OID</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (CurveInfoDto cr in this.edwardsCurves)
                    {
                        <tr>
                            <td>@cr.Kind</td>
                            <td>@cr.Name</td>
                            <td class="fst-italic">@cr.NamedCurve</td>
                            <td class="fst-italic">@cr.Oid</td>
                        </tr>
                    }
                </tbody>
            </table>

            <h2>Montgomery curves</h2>
            @if (this.montgomeryCurves == null)
            {
                <BouncyHsm.Spa.Shared.Common.LoadingIndicator />
            }
            else
            {
                <table class="table table-responsive-md table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>Kind</th>
                            <th>Curve</th>
                            <th>Curve Name</th>
                            <th>OID</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (CurveInfoDto cr in this.montgomeryCurves)
                        {
                            <tr>
                                <td>@cr.Kind</td>
                                <td>@cr.Name</td>
                                <td class="fst-italic">@cr.NamedCurve</td>
                                <td class="fst-italic">@cr.Oid</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }

            <h2>ML-DSA</h2>
            @if (this.mlDsa == null)
            {
                <BouncyHsm.Spa.Shared.Common.LoadingIndicator />
            }
            else
            {
                <table class="table table-responsive-md table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>Key</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (string name in this.mlDsa)
                        {
                            <tr>
                                <td>@name</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }

            <h2>SLH-DSA</h2>
            @if (this.slhDsa == null)
            {
                <BouncyHsm.Spa.Shared.Common.LoadingIndicator />
            }
            else
            {
                <table class="table table-responsive-md table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>Key</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (string name in this.slhDsa)
                        {
                            <tr>
                                <td>@name</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }

            <h2>ML-KEM</h2>
            @if (this.mlKem == null)
            {
                <BouncyHsm.Spa.Shared.Common.LoadingIndicator />
            }
            else
            {
                <table class="table table-responsive-md table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>Key</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (string name in this.mlKem)
                        {
                            <tr>
                                <td>@name</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        }
    }
}

@code {
    private IList<MechanismInfoDto>? mechanisms = null;
    private string? profileName = null;
    private IList<CurveInfoDto>? curves = null;
    private IList<CurveInfoDto>? edwardsCurves = null;
    private IList<CurveInfoDto>? montgomeryCurves = null;
    private IList<string>? mlDsa = null;
    private IList<string>? slhDsa = null;
    private IList<string>? mlKem = null;

    protected override async Task OnInitializedAsync()
    {
        await Task.Delay(1);
        MechanismProfileDto profileInfo = await this.bouncyHsmClient.GetMechanismAsync();
        this.mechanisms = profileInfo.Mechanisms.ToList();
        this.profileName = profileInfo.ProfileName;

        await Task.Yield();
        SupportedKeysDto keys = await this.bouncyHsmClient.GetSupportedKeysAsync();
        this.curves = keys.EcCurves.ToList();
        this.edwardsCurves = keys.EdwardsCurves.ToList();
        this.montgomeryCurves = keys.MontgomeryCurves.ToList();
        this.mlDsa = keys.MlDsaKeys.ToList();
        this.slhDsa = keys.SlhDsaKeys.ToList();
        this.mlKem = keys.MlKemKeys.ToList();
    }

    private string ShowFlag(bool enabled)
    {
        return enabled ? "✓" : " ";
    }

    private string ShowFlag(bool op1, bool op2)
    {
        return (op1, op2) switch
        {
            (false, false) => " ",
            (false, true) => "-",
            (true, false) => "-",
            (true, true) => "✓"
        };
    }

}
