@using BouncyHsm.Client;
@inject IBouncyHsmClient bouncyHsmClient
@inject NavigationManager Navigation
@inject ILogger<GenerateSlhDsaKeys> logger

@if (this.isInLoading)
{
    <LoadingIndicator />
}
else
{
    <EditForm EditContext="@editContext" OnValidSubmit="@HandleSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary class="text-danger" />

        <div class="mb-1">
            <label for="i-importmode" class="form-label">SLH-DSA parameter</label>

            <InputSelect class="form-select" @bind-Value="this.model.slhDsaParameter" id="i-importmode">
                @foreach (CK_SLH_DSA_PARAMETER_SET slhDsaParameter in this.slhDsaParameters)
                {
                    <option value="@slhDsaParameter" @key="slhDsaParameter">@slhDsaParameter</option>
                }
            </InputSelect>

            <ValidationMessage For="() => this.model.slhDsaParameter" />
        </div>
        <hr />

        <div class="row mb-1">
            <label for="i-ckaid" class="form-label">CKA ID</label>

            <div class="row">
                <div class="col-9">
                    <InputText id="i-ckaid" class="form-control" @bind-Value="this.model.CkaIdText" />
                </div>
                <div class="col-3">
                    <InputSelect class="form-select" @bind-Value="this.model.CkaIdForm">
                        <option value="@BinaryForm.Utf8">UTF-8</option>
                        <option value="@BinaryForm.Hex">HEX</option>
                        <option value="@BinaryForm.Base64">Base64</option>
                    </InputSelect>
                </div>
            </div>
            <div class="form-text">Value for CKA_ID is optinal. If is empty then will be generated on server.</div>
        </div>


        <div class="mb-1">
            <label for="i-ckaid" class="form-label">CKA LABEL</label>
            <InputText class="form-control" @bind-Value="this.model.CkaLabel" />
            <div class="form-text">Value for CKA_LABEL.</div>
            <ValidationMessage For="() => this.model.CkaLabel" />
        </div>


        <div class="mb-1 form-check">
            <InputCheckbox class="form-check-input" id="i-forsigning" @bind-Value="this.model.ForSigning" />
            <label class="form-check-label" for="i-forsigning">For signing and verification</label>
            <ValidationMessage For="() => this.model.ForSigning" />
        </div>
        <div class="mb-1 form-check">
            <InputCheckbox class="form-check-input" id="i-encryption" @bind-Value="this.model.ForEncryption" />
            <label class="form-check-label" for="i-encryption">For encryption and decryption</label>
            <ValidationMessage For="() => this.model.ForEncryption" />
        </div>
        <div class="mb-1 form-check">
            <InputCheckbox class="form-check-input" id="i-encapusltaion" @bind-Value="this.model.ForEncapsulation" />
            <label class="form-check-label" for="i-encapusltaion">For encapsulation and decapsulation</label>
            <ValidationMessage For="() => this.model.ForEncapsulation" />
        </div>
        <div class="mb-1 form-check">
            <InputCheckbox class="form-check-input" id="i-wrap" @bind-Value="this.model.ForWrap" />
            <label class="form-check-label" for="i-wrap">For wrap and unwrap</label>
            <ValidationMessage For="() => this.model.ForWrap" />
        </div>
        <div class="mb-1 form-check">
            <InputCheckbox class="form-check-input" id="i-derivation" @bind-Value="this.model.ForDerivation" />
            <label class="form-check-label" for="i-derivation">Private key can use for derivation</label>
            <ValidationMessage For="() => this.model.ForDerivation" />
        </div>
        <div class="mb-1 form-check">
            <InputCheckbox class="form-check-input" id="i-wrap" @bind-Value="this.model.Sensitive" />
            <label class="form-check-label" for="i-wrap">Private key is sensitive</label>
            <ValidationMessage For="() => this.model.Sensitive" />
        </div>
        <div class="mb-1 form-check">
            <InputCheckbox class="form-check-input" id="i-exportable" @bind-Value="this.model.Exportable" />
            <label class="form-check-label" for="i-exportable">Private key is exportable</label>
            <ValidationMessage For="() => this.model.Exportable" />
        </div>

        <div class="justify-content-end pt-4">
            <button type="submit" class="btn btn-primary"><span class="icon-plus icon-1x"></span> Submit</button>
        </div>
    </EditForm>
}
@code {

    [Parameter, EditorRequired]
    public int SlotId
    {
        get;
        set;
    }

    [Parameter]
    public EventCallback<bool> OnLoadingChanged
    {
        get;
        set;
    }

    private EditContext? editContext;
    private slhDsaGenModel model = new slhDsaGenModel();
    private bool isInLoading = false;
    private List<CK_SLH_DSA_PARAMETER_SET> slhDsaParameters = new List<CK_SLH_DSA_PARAMETER_SET>();

    protected override async Task OnInitializedAsync()
    {
        this.editContext = new EditContext(this.model);
        this.slhDsaParameters = Enum.GetValues<CK_SLH_DSA_PARAMETER_SET>().ToList();
    }

    private async Task HandleSubmit()
    {
        this.isInLoading = true;
        await this.OnLoadingChanged.InvokeAsync(true);
        await Task.Yield();
        try
        {
            _ = await this.bouncyHsmClient.GenerateSlhDsaKeyPairAsync(this.SlotId, this.model.ToDto());
            this.Navigation.NavigateTo($"Slots/{this.SlotId}/Pkcs");
        }
        catch (Exception ex)
        {
            this.logger.LogError(ex, "Error during GenerateSlhDsaKeyPairAsync.");
        }
        finally
        {
            this.isInLoading = false;
            await this.OnLoadingChanged.InvokeAsync(false);
        }
    }

    #region Model

    internal class slhDsaGenModel : BaseGenerateModel
    {
        [System.ComponentModel.DataAnnotations.Required]
        public string slhDsaParameter
        {
            get;
            set;
        }

        public slhDsaGenModel()
        {
            this.slhDsaParameter = nameof(CK_SLH_DSA_PARAMETER_SET.CKP_SLH_DSA_SHA2_128S);

            this.Sensitive = true;
            this.Exportable = false;

            this.ForWrap = false;
            this.ForEncryption = false;
            this.ForSigning = true;
            this.ForDerivation = false;
            this.ForEncapsulation = false;
        }

        internal GenerateSlhDsaKeyPairRequestDto ToDto()
        {
            return new GenerateSlhDsaKeyPairRequestDto()
            {
                SlhDsaParameter = Enum.Parse<CK_SLH_DSA_PARAMETER_SET>(this.slhDsaParameter),
                KeyAttributes = this.ToGenerateKeyAttributesDto()
            };
        }
    }

    #endregion
}
